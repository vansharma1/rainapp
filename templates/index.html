<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RainRoad - Modern Weather Map</title>
    <!-- Fonts & Libraries -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/ui-lightness/jquery-ui.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary-blue:#3b82f6; --light-blue:#64b5f6; --success-green:#10b981; --bg-light:#f8fafc; --bg-white:#fff; --text-primary:#1e293b; --text-secondary:#64748b; --border-color:#e2e8f0; --shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06); --shadow-lg:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05); }
        body { font-family:'Inter',sans-serif; background:linear-gradient(135deg,#667eea 0,#764ba2 100%); min-height:100vh; color:var(--text-primary);}
        .app-container { max-width:1200px; margin:0 auto; padding:20px; min-height:100vh; display:flex; flex-direction:column; gap:20px;}
        .header { text-align:center; margin-bottom:20px;}
        .header h1 { font-size:2.5rem; font-weight:700; color:#fff; margin-bottom:8px; text-shadow:0 2px 4px rgba(0,0,0,.1);}
        .header p { color:rgba(255,255,255,.8); font-size:1.1rem;}
        .search-card { background:var(--bg-white); border-radius:16px; padding:24px; box-shadow:var(--shadow-lg); backdrop-filter:blur(10px); background:rgba(255,255,255,.95);}
        .search-form { display:flex; gap:12px; align-items:center;}
        .search-input { flex:1; padding:12px 16px; border:2px solid var(--border-color); border-radius:12px; font-size:16px; background:#fff; font-weight:400; transition:.2s;}
        .search-input:focus { border-color:var(--primary-blue); box-shadow:0 0 0 3px rgba(59,130,246,.1);}
        .search-btn { padding:12px 24px; background:var(--primary-blue); color:#fff; border:none; border-radius:12px; font-weight:500; cursor:pointer; display:flex; align-items:center; gap:8px; transition:.2s;}
        .search-btn:hover { background:#2564eb; }
        .weather-card { background:var(--bg-white); border-radius:16px; padding:24px; box-shadow:var(--shadow-lg); backdrop-filter:blur(10px); background:rgba(255,255,255,.95); display:none;}
        .weather-card.show { display:block; animation:slideIn .3s ease;}
        @keyframes slideIn { from{opacity:0;transform:translateY(20px);} to{opacity:1;transform:translateY(0);} }
        .weather-header { text-align:center; margin-bottom:24px;}
        .location-name { font-size:1.5rem; font-weight:600; color:var(--text-primary); margin-bottom:8px;}
        .weather-main { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:20px;}
        .weather-stat { background:rgba(59,130,246,.05); padding:16px; border-radius:12px; text-align:center; border:1px solid rgba(59,130,246,.1);}
        .stat-label { font-size:.875rem; color:var(--text-secondary); margin-bottom:4px; text-transform:uppercase; font-weight:500;}
        .stat-value { font-size:1.5rem; font-weight:600;}
        .rain-status { padding:8px 16px; border-radius:20px; font-weight:500; font-size:.875rem; display:inline-block; margin-top:8px;}
        .rain-status.raining { background:rgba(239,68,68,.1); color:#dc2626;}
        .rain-status.dry { background:rgba(16,185,129,.1); color:#059669;}
        .map-container { flex:1; background:var(--bg-white); border-radius:16px; overflow:hidden; box-shadow:var(--shadow-lg); min-height:500px; position:relative;}
        #map { width:100%; height:100%; min-height:500px;}
        .instructions { position:absolute; top:20px; left:20px; right:20px; background:rgba(255,255,255,.95); padding:12px 16px; border-radius:8px; font-size:.875rem; color:var(--text-secondary); box-shadow:var(--shadow); z-index:1000; text-align:center;}
        .legend { background:rgba(255,255,255,.95)!important; padding:16px!important; border-radius:12px!important; font-size:13px!important; box-shadow:var(--shadow-lg)!important; border:none!important;}
        .legend h4 {margin:0 0 12px 0!important;font-size:14px!important;font-weight:600!important;color:var(--text-primary)!important;}
        .legend-item{display:flex;align-items:center;margin:6px 0;}
        .legend-color{width:20px;height:12px;border-radius:3px;margin-right:8px;border:1px solid rgba(0,0,0,.1);}
        .error-message {color:#dc2626; background:rgba(239,68,68,.1);padding:12px 16px;border-radius:8px;border-left:4px solid #dc2626;font-weight:500;}
        @media(max-width:768px){.app-container{padding:16px;}.header h1{font-size:2rem;}.search-form{flex-direction:column;}.search-input{width:100%;}.weather-main{grid-template-columns:1fr;}.instructions{left:10px;right:10px;font-size:.8rem;}}
        .ui-autocomplete{background:white!important;border:1px solid var(--border-color)!important;border-radius:8px!important;box-shadow:var(--shadow-lg)!important;max-height:200px;overflow-y:auto;}
        .ui-menu-item{padding:8px 12px!important;border-bottom:1px solid rgba(0,0,0,.05)!important;}
        .ui-menu-item:hover,.ui-state-focus{background:rgba(59,130,246,.05)!important;border:none!important;}
    </style>
</head>
<body>
<div class="app-container">
    <div class="header">
        <h1><i class="fas fa-cloud-rain"></i> RainRoad</h1>
        <p>Live weather and rain tracking ‚Äî by road and by tap</p>
    </div>
    <div class="search-card">
        <form method="post" class="search-form" autocomplete="off">
            <input type="text" name="city" id="city-input" class="search-input"
                   placeholder="Search any location (e.g. Pauri, Lajpat Nagar Delhi)" required autocomplete="off">
            <button type="submit" class="search-btn">
                <i class="fas fa-search"></i> Search
            </button>
        </form>
    </div>
    {% if weather %}
    <div class="weather-card show">
        {% if weather.error %}
            <div class="error-message">
                <i class="fas fa-exclamation-triangle"></i>
                {{ weather.error }}
            </div>
        {% else %}
            <div class="weather-header">
                <div class="location-name">{{ weather.city }}</div>
            </div>
            <div class="weather-main">
                <div class="weather-stat">
                    <div class="stat-label">Temperature</div>
                    <div class="stat-value">{{ weather.temp }}¬∞C</div>
                </div>
                <div class="weather-stat">
                    <div class="stat-label">Condition</div>
                    <div class="stat-value">{{ weather.description|title }}</div>
                </div>
                <div class="weather-stat">
                    <div class="stat-label">Rain Status</div>
                    <div class="stat-value">
                        {% if weather.rain %}
                            <span class="rain-status raining">
                                <i class="fas fa-cloud-rain"></i> Raining
                            </span>
                        {% else %}
                            <span class="rain-status dry">
                                <i class="fas fa-sun"></i> Dry
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
    {% endif %}
    <div class="map-container">
        <div class="instructions">
            <i class="fas fa-info-circle"></i>
            <span>Click anywhere on the map for live weather. <b>Double-tap to zoom in (no popup).</b></span>
        </div>
        <div id="map"></div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
var lat = {{ lat }};
var lon = {{ lon }};
var map = L.map('map').setView([lat, lon], 12);
// Base map
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);
// City marker
var marker = L.marker([lat, lon]).addTo(map)
    .bindPopup("üìç {{ weather.city if weather and not weather.error else 'Current Location' }}")
    .openPopup();
// Legend
var legend = L.control({position: 'bottomright'});
legend.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'legend');
    div.innerHTML = '<h4><i class="fas fa-map-marked-alt"></i> Road Conditions</h4>' +
        '<div class="legend-item"><div class="legend-color" style="background:#64b5f6;"></div><span>Rainy Roads</span></div>' +
        '<div class="legend-item"><div class="legend-color" style="background:#10b981;"></div><span>Dry Roads</span></div>';
    return div;
};
legend.addTo(map);
// Draw roads with blue/green color
function loadRoadWeather() {
    fetch('/get_road_weather', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lat: lat, lon: lon })
    })

    .then(response => response.json())
    .then(data => {
        map.eachLayer(function(layer) {
            if (layer instanceof L.Polyline && !(layer instanceof L.Marker)) {
                map.removeLayer(layer);
            }
        });
        data.forEach(function(road) {
            var color = road.is_raining ? '#64b5f6' : '#10b981';
            var weight = road.is_raining ? 6 : 4;
            L.polyline(road.coordinates, {
                color: color,
                weight: weight,
                opacity: 0.7,
                smoothFactor: 1
            }).addTo(map).bindPopup(
                `<div style="text-align:center;">
                    <strong>${road.name}</strong><br>
                    ${road.is_raining
                        ? '<span style="color:#3b82f6;"><i class="fas fa-cloud-rain"></i> Rainy</span>'
                        : '<span style="color:#10b981;"><i class="fas fa-sun"></i> Dry</span>'}
                 </div>`
            );
        });
    })
    .catch(error => {
        console.error('Error loading road weather:', error);
    });
}
{% if weather and not weather.error %}
    loadRoadWeather();
{% endif %}

// Tap/double-tap distinction for single vs. double tap action
let tapTimeout;
const tapDelay = 300;
var clickMarkers = [];
function onMapSingleClick(e) {
    var clickLat = e.latlng.lat, clickLon = e.latlng.lng;
    clickMarkers.forEach(marker => map.removeLayer(marker));
    clickMarkers = [];
    var tempMarker = L.marker([clickLat, clickLon]).addTo(map);
    clickMarkers.push(tempMarker);
    tempMarker.bindPopup('<i class="fas fa-spinner fa-spin"></i> Loading weather...').openPopup();
    fetch(`/point_weather?lat=${clickLat}&lon=${clickLon}`)
        .then(response => response.json())
        .then(data => {
            tempMarker.setPopupContent(
                `<div style="text-align:center;min-width:150px;">
                  <strong><i class="fas fa-map-marker-alt"></i> Weather Here</strong><br><br>
                  <div><strong>${data.temp}¬∞C</strong></div>
                  <div style="color:#64748b;margin:4px 0;">${data.desc}</div>
                  ${data.rain_desc || '<span style="color:#10b981;"><i class="fas fa-sun"></i> No Rain</span>'}
                </div>`)
                .openPopup();
        })
        .catch(() => tempMarker.setPopupContent('<span style="color:red;">Weather unavailable</span>'));
}
map.on('click', function(e) {
    if (tapTimeout) {
        clearTimeout(tapTimeout);
        tapTimeout = null;
        return;
    }
    tapTimeout = setTimeout(() => {
        onMapSingleClick(e);
        tapTimeout = null;
    }, tapDelay);
});
map.on('dblclick', function() {
    if (tapTimeout) {
        clearTimeout(tapTimeout);
        tapTimeout = null;
    }
    // Default zoom still occurs
});

// Autocomplete for area names using LocationIQ
$("#city-input").autocomplete({
    minLength: 2,
    delay: 300,
    source: function(request, response) {
        $.ajax({
            url: "/autocomplete",
            dataType: "json",
            data: { q: request.term },
            success: function(data) {
                response($.map(data, function(item) {
                    return {
                        label: item.label,
                        value: item.label
                    };
                }));
            },
            error: function() {
                response([]);
            }
        });
    }
});

// Fixes for rendering in some responsive layouts
setTimeout(function() {
    map.invalidateSize();
}, 150);
</script>
</body>
</html>
